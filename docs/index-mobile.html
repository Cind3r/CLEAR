<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Hospital Price Finder - Mobile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <!-- d3 as global (ok inside module) -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
  :root{--bg:#0f172a;--ink:#e2e8f0;--muted:#9aa6b2;}
  *{box-sizing:border-box}
  html{overflow-x:hidden}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px system-ui,Segoe UI,Roboto,Helvetica,Arial;overflow-x:hidden;width:100%;max-width:100vw}
  
  /* Mobile-optimized header */
  header{background:rgba(15,23,42,.95);padding:1rem;text-align:center;width:100%;box-sizing:border-box}
  .header-section{margin-bottom:1rem;display:flex;flex-direction:column;align-items:center;width:100%;max-width:100%}
  .header-row{display:flex;gap:.75rem;align-items:stretch;margin-bottom:.75rem;flex-wrap:wrap;justify-content:center;width:100%;max-width:100%}
  .header-row:last-child{margin-bottom:0}
  
  /* Mobile-friendly form elements */
  input,select,button{background:#111827;color:var(--ink);border:1px solid #1f2937;border-radius:.5rem;padding:.75rem;font-size:16px;min-height:44px;width:100%;max-width:100%;box-sizing:border-box}
  label{display:block;margin-bottom:.5rem;font-weight:500;width:100%;max-width:100%;text-align:center}
  label span{display:block;margin-bottom:.25rem;font-size:14px;text-align:center}
  input[type="checkbox"]{width:auto;height:auto;margin-right:.5rem;max-width:none}
  button{cursor:pointer;background:#374151;font-weight:600;width:100%;margin-top:.75rem;max-width:100%}
  button:active{background:#4b5563}
  #status{color:var(--muted);font-size:14px;margin-top:.5rem;word-wrap:break-word;overflow-wrap:break-word}
  
  /* Mobile layout - stacked instead of side-by-side */
  main{display:block}
  
  /* Map section */
  .map-container{position:relative;height:50vh;min-height:300px;margin-bottom:1rem;border:1px solid #1f2937;border-radius:.5rem;overflow:hidden}
  svg{display:block;width:100%;height:100%}
  .reset-zoom-btn{position:absolute;bottom:1rem;left:50%;transform:translateX(-50%);background:#1f2937;color:var(--ink);border:1px solid #374151;border-radius:.5rem;padding:.5rem 1rem;cursor:pointer;font-size:12px;z-index:5;transition:all 0.2s ease;min-height:36px}
  .reset-zoom-btn:active{background:#374151;border-color:#4b5563}
  
  /* Results section */
  .results-section{padding:1rem;border-top:1px solid #1f2937}
  .results-header{margin-bottom:1rem}
  #list-title{margin:0;font-size:18px}
  .toggle-all-btn{background:#374151;border:1px solid #4b5563;color:var(--ink);padding:.75rem 1.5rem;border-radius:.5rem;cursor:pointer;font-size:14px;min-height:44px}
  
  /* Visualization section - mobile adapted */
  .visualization-section{padding:1rem;border-top:1px solid #1f2937;background:#0a0f1c}
  .viz-container{display:block;gap:1rem}
  .viz-panel{border:1px solid #1f2937;border-radius:.6rem;padding:1rem;background:#0b1325;margin-bottom:1rem;min-height:300px}
  .viz-panel h3{margin:0 0 1rem;color:#e2e8f0;font-size:16px}
  .viz-svg{width:100%;height:250px}
  
  /* Info section - mobile adapted */
  .info-section{padding:1rem;background:#0a0f1c}
  .info-container{line-height:1.6}
  .info-section h2{color:#e2e8f0;font-size:20px;margin-bottom:1rem;text-align:center}
  .info-section h3{color:#cbd5e1;font-size:16px;margin:1.5rem 0 .75rem;display:flex;align-items:center;gap:.5rem}
  .info-section h4{color:#9ca3af;font-size:14px;margin:1rem 0 .5rem}
  .info-section p{color:#d1d5db;margin-bottom:1rem}
  .info-section ol{color:#d1d5db;padding-left:1.5rem}
  .info-section li{margin-bottom:.5rem}
  .plot-explanations{display:block;margin:2rem 0}
  .plot-explanation{background:#0f172a;border:1px solid #1f2937;border-radius:.8rem;padding:1.5rem;margin-bottom:1rem}
  .technical-note{background:#1e293b;border-left:3px solid #3b82f6;padding:1rem;margin:1rem 0;border-radius:0 .5rem .5rem 0}
  .technical-note ul{margin:.5rem 0;padding-left:1.5rem}
  .technical-note li{margin-bottom:.25rem}
  .usage-guide{background:#0f172a;border:1px solid #1f2937;border-radius:.8rem;padding:1.5rem;margin-top:2rem}
  
  /* Mobile-optimized cards */
  .card{border:1px solid #1f2937;background:#0b1325;border-radius:.6rem;padding:1rem;margin-bottom:1rem}
  .card code{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:14px}
  
  /* Map styling */
  .state{fill:#1e293b;stroke:#94a3b8;stroke-width:.6px}
  .graticule{fill:none;stroke:#334155;stroke-opacity:.35}
  .circle{fill:rgba(99,102,241,.12);stroke:#8b5cf6;stroke-width:1.5px}
  .marker-zip{fill:#f43f5e;stroke:#fff;stroke-width:1.2px}
  .marker-hosp{fill:#22c55e;stroke:#0b1325;stroke-width:1px}
  
  /* Mobile-friendly text */
  .small{font-size:14px;color:#93a4b3}
  .badge{display:inline-block;padding:.2rem .5rem;border:1px solid #334155;border-radius:.4rem;margin-left:.3rem;color:#cbd5e1;font-size:12px}
  
  /* Price items - mobile optimized */
  .price-item{border:1px solid #1f2937;border-radius:.4rem;padding:1rem;margin-top:1rem;transition:all 0.2s ease}
  .price-item:active{border-color:#334155;background:rgba(15,23,42,.3)}
  .hospital-header{cursor:pointer;transition:background 0.2s ease;padding:1rem;border-radius:.4rem}
  .hospital-header:active{background:rgba(15,23,42,.5)}
  .hospital-prices{display:none;margin-top:1rem;border-top:1px solid #1f2937;padding-top:1rem}
  .hospital-prices.expanded{display:block}
  .toggle-indicator{float:right;font-size:20px;transition:transform 0.2s ease;min-width:44px;min-height:44px;display:flex;align-items:center;justify-content:center}
  .toggle-indicator.expanded{transform:rotate(90deg)}
  .payer-info{font-weight:bold;margin-bottom:.5rem;color:#cbd5e1}
  
  /* Mobile-optimized price table */
  .price-table{width:100%;border-collapse:collapse;margin-top:.5rem;font-size:14px}
  .price-table th{background:#1f2937;color:#e2e8f0;padding:.75rem;text-align:left;border:1px solid #374151;font-weight:600}
  .price-table td{padding:.75rem;border:1px solid #374151;color:#d1d5db}
  .price-table tr:nth-child(even){background:rgba(31,41,55,.3)}
  .price-table .price-type{font-weight:500;color:#93c5fd}
  
  /* Visualization styling */
  .axis{color:#94a3b8;font-size:12px}
  .axis line,.axis path{stroke:#94a3b8}
  .distribution-bar{fill:#8b5cf6;opacity:0.7}
  .distribution-bar:hover{opacity:1}
  .slope-dot{fill:#22c55e;stroke:#fff;stroke-width:1}
  .hospital-label{fill:#e2e8f0;font-size:10px}
  
  /* Touch-friendly improvements */
  .clickable{min-height:44px;min-width:44px}
  
  /* Hide desktop link on mobile */
  .desktop-link{display:none}
  
  /* Mobile navigation */
  .mobile-nav{position:fixed;bottom:0;left:0;right:0;background:rgba(15,23,42,.95);backdrop-filter:blur(8px);border-top:1px solid #1f2937;padding:1rem;z-index:20;display:none}
  .mobile-nav.show{display:block}
  .nav-buttons{display:flex;gap:.5rem}
  .nav-btn{flex:1;padding:.75rem;background:#374151;color:var(--ink);border:1px solid #4b5563;border-radius:.5rem;text-align:center;cursor:pointer;font-size:14px}
  .nav-btn:active{background:#4b5563}
  
  /* Smooth scrolling */
  html{scroll-behavior:smooth}
  
  /* Loading states */
  .loading{opacity:0.7;pointer-events:none}
  .loading::after{content:"Loading...";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(15,23,42,.9);padding:1rem;border-radius:.5rem;z-index:100}
  </style>
</head>
<body>
  <!-- Desktop redirect notification -->
  <div id="desktop-redirect" style="display:none;position:fixed;top:0;left:0;right:0;background:#1e40af;color:white;padding:1rem;text-align:center;z-index:1000;">
    <p style="margin:0;">For the best experience on larger screens, <a href="index.html" style="color:#93c5fd;text-decoration:underline;">switch to desktop version</a></p>
    <button onclick="document.getElementById('desktop-redirect').style.display='none'" style="position:absolute;top:0.5rem;right:1rem;background:none;border:none;color:white;font-size:20px;">√ó</button>
  </div>

  <header>
    <div class="header-section">
      <label>
        <span>Service Group:</span>
        <select id="service">
          <option value="">(Select Group)</option>
        </select>
      </label>
    </div>
    
    <div class="header-section" id="procedure-section" style="display: none;">
      <label>
        <span>Procedure (regex or code):</span>
        <input id="q" placeholder="e.g. (MRI|70551)|^70551$"/>
      </label>
    </div>
    
    <div class="header-row">
      <label style="flex:1;min-width:0;max-width:48%">
        <span>ZIP Code:</span>
        <input id="zip" placeholder="e.g. 27587"/>
      </label>
      <label style="flex:1;min-width:0;max-width:48%">
        <span>Radius:</span>
        <select id="radius">
          <option value="10">10 mi</option>
          <option value="25" selected>25 mi</option>
          <option value="50">50 mi</option>
          <option value="100">100 mi</option>
          <option value="250">250 mi</option>
          <option value="500">500 mi+</option>
        </select>
      </label>
    </div>
    
    <div class="header-section">
      <label>
        <span>Insurance Payer:</span>
        <select id="payer">
          <option value="">All Payers</option>
        </select>
      </label>
    </div>
    
    <div class="header-section">
      <label style="display:flex;align-items:center">
        <input id="unit" type="checkbox" />
        <span>Show as ratio-to-Medicare</span>
      </label>
    </div>
    
    <button id="go">Search Hospitals</button>
    <div id="status"></div>
  </header>

  <main>
    <div class="map-container">
      <svg id="map" viewBox="0 0 960 600" aria-label="US map"></svg>
      <button id="reset-zoom" class="reset-zoom-btn">üîç Reset Zoom</button>
    </div>
    
    <div class="results-section">
      <div class="results-header">
        <h3 id="list-title" style="text-align:center;margin-bottom:0.5rem;">Hospitals (0)</h3>
        <div style="text-align:center;margin-bottom:1rem;">
          <button class="toggle-all-btn" onclick="toggleAllHospitals()">Expand All</button>
        </div>
      </div>
      <div class="small" style="margin-bottom:1rem;text-align:center;">Shows hospitals within the radius; price matches appear under each hospital.</div>
      <div id="list"></div>
    </div>
  </main>

  <div class="visualization-section">
    <div class="viz-container">
      <div class="viz-panel">
        <h3>üìä Price Distribution</h3>
        <svg id="distribution-chart" class="viz-svg"></svg>
      </div>
      <div class="viz-panel">
        <h3>üìà Hospital Price Comparison</h3>
        <svg id="slopegraph-chart" class="viz-svg"></svg>
      </div>
    </div>
  </div>

  <div class="info-section">
    <div class="info-container">
      <h2>About This Tool</h2>
      <p>The <strong>Hospital Price Finder</strong> helps you discover and compare healthcare procedure costs across hospitals within a specified radius of any ZIP code. Search by procedure codes (CPT, HCPCS) or custom patterns to find pricing transparency data from hospital charge masters.</p>
      
      <div class="plot-explanations">
        <div class="plot-explanation">
          <h3>üìä Price Distribution Chart</h3>
          <p>Shows the frequency distribution of all individual price points found for your search. This histogram displays every price entry (estimated amounts, minimum charges, maximum charges) from all matching procedures across all hospitals. Each bar represents how many procedures fall within that price range, giving you an overview of the overall pricing landscape.</p>
        </div>
        
        <div class="plot-explanation">
          <h3>üìà Hospital Price Comparison (Slope Chart)</h3>
          <p>Compares average minimum vs. maximum prices per hospital. Each colored line represents one hospital, connecting the average of all minimum prices (left) to the average of all maximum prices (right) for matching procedures. Tap lines to see hospital names and exact values.</p>
          
          <div class="technical-note">
            <h4>üìã Data Calculation Details</h4>
            <ul>
              <li><strong>Slope Chart:</strong> Averages multiple procedures per hospital into single min/max values</li>
              <li><strong>Results List:</strong> Shows individual procedure records with specific min/max prices</li>
              <li><strong>Histogram:</strong> Plots every individual price point from all procedures</li>
            </ul>
            <p><em>Note: If a hospital appears in multiple matching procedures, the slope chart shows averages while the results list displays each individual procedure separately. This explains why slope chart values may not exactly match individual result entries.</em></p>
          </div>
        </div>
      </div>
      
      <div class="usage-guide">
        <h3>üîç How to Use</h3>
        <ol>
          <li>Select a predefined service or enter a custom procedure pattern (regex supported)</li>
          <li>Enter a ZIP code and choose your search radius</li>
          <li>Optionally filter by insurance payer or view prices as ratios to Medicare rates</li>
          <li>Tap search to see hospitals on the map and pricing data in the results</li>
          <li>Scroll down to analyze price distributions and hospital comparisons</li>
          <li>Use the reset zoom button to return to the full map view</li>
        </ol>
      </div>
    </div>
  </div>

  <!-- Mobile navigation (hidden by default) -->
  <div class="mobile-nav" id="mobile-nav">
    <div class="nav-buttons">
      <div class="nav-btn" onclick="scrollToSection('map')">Map</div>
      <div class="nav-btn" onclick="scrollToSection('results')">Results</div>
      <div class="nav-btn" onclick="scrollToSection('charts')">Charts</div>
      <div class="nav-btn" onclick="scrollToSection('info')">Info</div>
    </div>
  </div>

  <script type="module">
  import * as topojson from "https://cdn.jsdelivr.net/npm/topojson-client@3/+esm";

  // Mobile-specific initialization
  let allExpanded = false;
  
  // Check if user should see desktop version suggestion
  if (window.innerWidth >= 1024) {
    document.getElementById('desktop-redirect').style.display = 'block';
  }
  
  // Mobile navigation functions
  window.scrollToSection = function(section) {
    const sections = {
      'map': document.querySelector('.map-container'),
      'results': document.querySelector('.results-section'),
      'charts': document.querySelector('.visualization-section'),
      'info': document.querySelector('.info-section')
    };
    
    if (sections[section]) {
      sections[section].scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  };
  
  // Toggle all hospitals function
  window.toggleAllHospitals = function() {
    const allPrices = document.querySelectorAll('.hospital-prices');
    const allToggles = document.querySelectorAll('.toggle-indicator');
    const toggleBtn = document.querySelector('.toggle-all-btn');
    
    allExpanded = !allExpanded;
    
    allPrices.forEach((pricesDiv, index) => {
      const toggle = allToggles[index];
      
      if (allExpanded) {
        pricesDiv.classList.add('expanded');
        toggle.classList.add('expanded');
        toggle.textContent = '‚ñº';
      } else {
        pricesDiv.classList.remove('expanded');
        toggle.classList.remove('expanded');
        toggle.textContent = '‚ñ∂';
      }
    });
    
    toggleBtn.textContent = allExpanded ? 'Collapse All' : 'Expand All';
  };

  // --------- CONFIG / URL HELPERS ----------
  const WIDTH = 960, HEIGHT = 600, EARTH_MI = 3958.7613;
  const ENABLE_PRICES = true;  // set false to debug map/CSV only

  // robust path resolution relative to this HTML file
  const urlFrom = (p) => p;  // Simple relative path resolution
  const DATA_ZIPS = "data/zip_centroids.csv";
  const DATA_HOSPS = "data/hospitals.csv";
  const DATA_SERVICE = "data/service_config.json";
  const DATA_CMS = "data/cms_anchor_2024.csv";
  const jsonUrl = (relPath) => relPath.startsWith('docs/') ? relPath.substring(5) : relPath;

  // --------- ELEMENTS ----------
  const svg = d3.select("#map");
  const $q = document.getElementById("q");
  const $zip = document.getElementById("zip");
  const $radius = document.getElementById("radius");
  const $payer = document.getElementById("payer");
  const $service = document.getElementById("service");
  const $unit = document.getElementById("unit");
  const $go = document.getElementById("go");
  const $status = document.getElementById("status");
  const $list = document.getElementById("list");
  const $listTitle = document.getElementById("list-title");
  const setStatus = (t)=> $status.textContent = t;

  // --------- DATA MAPS ----------
  const cmsRate = new Map();
  const services = new Map();

  // --------- MAP ----------
  const projection = d3.geoAlbersUsa().translate([WIDTH/2, HEIGHT/2]).scale(1200);
  const path = d3.geoPath(projection);
  const gBase = svg.append("g");
  const gOverlay = svg.append("g");
  
  // Mobile-optimized zoom behavior - disabled panning, only programmatic zoom
  const zoom = d3.zoom().scaleExtent([1, 20])
    .filter(event => {
      // Disable all user interactions - no touch pan/zoom
      return false;
    })
    .on("zoom", (ev) => {
      gBase.attr("transform", ev.transform);
      gOverlay.attr("transform", ev.transform);
      gOverlay.selectAll(".marker-zip").attr("r", 4/ev.transform.k);
      gOverlay.selectAll(".marker-hosp").attr("r", 3.5/ev.transform.k);
    });
  svg.call(zoom);

  // Reset zoom button functionality
  document.getElementById('reset-zoom').addEventListener('click', () => {
    svg.transition().duration(800)
       .call(zoom.transform, d3.zoomIdentity);
  });

  const circlePath = gOverlay.append("path").attr("class","circle").style("display","none");
  const zipMarker  = gOverlay.append("circle").attr("class","marker-zip").attr("r",4).style("display","none");
  const hospLayer  = gOverlay.append("g").attr("class","hospitals");

  const miles2deg = (mi)=> mi/69;
  const gcMiles = (aLonLat, bLonLat)=> d3.geoDistance(aLonLat, bLonLat) * EARTH_MI;
  function zoomTo(feature, pad=20){
    const [[x0,y0],[x1,y1]] = path.bounds(feature);
    const dx=x1-x0, dy=y1-y0, cx=(x0+x1)/2, cy=(y0+y1)/2;
    const scale = Math.max(1, Math.min(20, 0.9/Math.max(dx/(WIDTH-2*pad), dy/(HEIGHT-2*pad))));
    const translate = [WIDTH/2 - scale*cx, HEIGHT/2 - scale*cy];
    svg.transition().duration(800)
       .call(zoom.transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale));
  }

  // 1) BASEMAP FIRST (isolated)
  try {
    const graticule = d3.geoGraticule10();
    gBase.append("path").attr("class","graticule").attr("d", path(graticule));
    const res = await fetch("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json");
    if (!res.ok) throw new Error(`us-atlas fetch failed: ${res.status}`);
    const us = await res.json();
    const states = topojson.feature(us, us.objects.states).features;
    gBase.selectAll("path.state").data(states).join("path").attr("class","state").attr("d", path);
  } catch (err) {
    console.error("Basemap error:", err);
    setStatus("Basemap failed to load. See console.");
  }

  // 2) SMALL CSVs
  let ZIP = new Map(), hospitals = [];
  try {
    const zipRows = await d3.csv(DATA_ZIPS, d3.autoType);
    ZIP = new Map(zipRows.map(d=>[String(d.zip).padStart(5,'0'), [d.lat, d.lon]]));
  } catch (e) {
    console.warn("zip_centroids.csv failed:", e);
    setStatus("ZIP data missing.");
  }
  try {
    hospitals = await d3.csv(DATA_HOSPS, d3.autoType);
    hospitals.forEach(d => { 
      d.ll = [d.lon, d.lat]; 
      // Use json_path from CSV
      d.json_path = d.json_path || '';
    });

  } catch (e) {
    console.warn("hospitals.csv failed:", e);
    setStatus("Hospitals index missing.");
  }

  // 3) Load service configuration and CMS rates
  try {
    const svcCfg = await fetch(DATA_SERVICE).then(r=>r.json());
    Object.entries(svcCfg).forEach(([name, obj])=>{
      services.set(name, new RegExp(obj.pattern, 'i'));
      const opt = document.createElement('option'); 
      opt.value = name; 
      opt.textContent = name;
      $service.appendChild(opt);
    });
    // Add Custom Pattern option at the end
    const customOpt = document.createElement('option');
    customOpt.value = 'custom';
    customOpt.textContent = 'Custom Pattern';
    $service.appendChild(customOpt);
  } catch (e) {
    console.warn("service_config.json failed:", e);
    // Still add Custom Pattern option even if service config fails
    const customOpt = document.createElement('option');
    customOpt.value = 'custom';
    customOpt.textContent = 'Custom Pattern';
    $service.appendChild(customOpt);
  }

  try {
    const cmsRows = await d3.csv(DATA_CMS, d3.autoType);
    cmsRows.forEach(r => cmsRate.set(String(r.code), +r.medicare_rate_2024 || 0));
  } catch (e) {
    console.warn("cms_anchor_2024.csv failed:", e);
  }

  // 4) JSON Loading Cache
  const jsonCache = new Map(); // Cache loaded JSON files

  // --------- HELPER FUNCTIONS ----------
  // Helper: choose a usable $ amount per record
  const amountOf = r => +r.estimated_amount || +r.standard_charge_dollar || +r.standard_charge_gross
                    || +r.standard_charge_min || +r.standard_charge_max || 0;

  // Helper: format price display - returns object with price and ratio
  const formatPrice = (amount, code) => {
    if (!amount || amount === 0) return { price: "N/A", ratio: "N/A" };
    
    const price = `$${Number(amount).toLocaleString()}`;
    let ratio = "N/A";
    
    if (code) {
      const medicareRate = cmsRate.get(String(code)) || 0;
      if (medicareRate > 0) {
        ratio = `${(amount / medicareRate).toFixed(2)}x`;
      }
    }
    
    return { price, ratio };
  };

  // Helper: generate price table HTML
  const generatePriceTable = (record) => {
    const showRatio = $unit.checked;
    const priceTypes = [];
    
    if (record.estimated_amount != null) {
      const formatted = formatPrice(record.estimated_amount, record.code);
      priceTypes.push({ type: "Estimate", price: formatted.price, ratio: formatted.ratio });
    }
    if (record.standard_charge_min != null) {
      const formatted = formatPrice(record.standard_charge_min, record.code);
      priceTypes.push({ type: "Minimum", price: formatted.price, ratio: formatted.ratio });
    }
    if (record.standard_charge_max != null) {
      const formatted = formatPrice(record.standard_charge_max, record.code);
      priceTypes.push({ type: "Maximum", price: formatted.price, ratio: formatted.ratio });
    }
    
    if (priceTypes.length === 0) return "<div class='small'>No pricing data available</div>";
    
    return `
      <table class="price-table">
        <thead>
          <tr>
            <th></th>
            <th>Price</th>
            ${showRatio ? '<th>Medicare Ratio</th>' : ''}
          </tr>
        </thead>
        <tbody>
          ${priceTypes.map(pt => `
            <tr>
              <td class="price-type">${pt.type}</td>
              <td>${pt.price}</td>
              ${showRatio ? `<td>${pt.ratio}</td>` : ''}
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  };

  // --------- VISUALIZATION FUNCTIONS ----------
  const distributionSvg = d3.select("#distribution-chart");
  const slopegraphSvg = d3.select("#slopegraph-chart");

  // Create distribution histogram - mobile optimized
  function createDistributionChart(allHits) {
    distributionSvg.selectAll("*").remove();
    
    if (!allHits || allHits.length === 0) {
      distributionSvg.append("text")
        .attr("x", "50%")
        .attr("y", "50%")
        .attr("text-anchor", "middle")
        .attr("fill", "#94a3b8")
        .style("font-size", "14px")
        .text("No data to display");
      return;
    }

    const margin = {top: 20, right: 20, bottom: 50, left: 50};
    const containerWidth = parseInt(distributionSvg.style("width")) || 300;
    const containerHeight = parseInt(distributionSvg.style("height")) || 250;
    const width = containerWidth - margin.left - margin.right;
    const height = containerHeight - margin.top - margin.bottom;

    const g = distributionSvg.append("g")
      .attr("transform", `translate(${margin.left},${margin.top})`);

    // Get all price values
    const prices = [];
    allHits.forEach(hit => {
      if (hit.estimated_amount != null) prices.push(+hit.estimated_amount);
      if (hit.standard_charge_min != null) prices.push(+hit.standard_charge_min);
      if (hit.standard_charge_max != null) prices.push(+hit.standard_charge_max);
    });

    if (prices.length === 0) {
      g.append("text")
        .attr("x", width/2)
        .attr("y", height/2)
        .attr("text-anchor", "middle")
        .attr("fill", "#94a3b8")
        .style("font-size", "14px")
        .text("No price data available");
      return;
    }

    // Create histogram
    const xScale = d3.scaleLinear()
      .domain(d3.extent(prices))
      .range([0, width]);

    const histogram = d3.histogram()
      .value(d => d)
      .domain(xScale.domain())
      .thresholds(Math.min(15, Math.ceil(Math.sqrt(prices.length))));

    const bins = histogram(prices);

    const yScale = d3.scaleLinear()
      .domain([0, d3.max(bins, d => d.length)])
      .range([height, 0]);

    // Add bars with touch-friendly interaction
    g.selectAll("rect")
      .data(bins)
      .join("rect")
      .attr("class", "distribution-bar")
      .attr("x", d => xScale(d.x0))
      .attr("width", d => Math.max(0, xScale(d.x1) - xScale(d.x0) - 1))
      .attr("y", d => yScale(d.length))
      .attr("height", d => height - yScale(d.length))
      .style("cursor", "pointer")
      .on("touchstart", function(event, d) {
        event.preventDefault();
        // Show tooltip for mobile
        alert(`Price Range: $${d.x0.toLocaleString()} - $${d.x1.toLocaleString()}\nCount: ${d.length} prices`);
      });

    // Add axes
    g.append("g")
      .attr("class", "axis")
      .attr("transform", `translate(0,${height})`)
      .call(d3.axisBottom(xScale).tickFormat(d => `$${d/1000}k`).ticks(5));

    g.append("g")
      .attr("class", "axis")
      .call(d3.axisLeft(yScale).ticks(5));

    // Add labels
    g.append("text")
      .attr("x", width/2)
      .attr("y", height + 40)
      .attr("text-anchor", "middle")
      .attr("fill", "#e2e8f0")
      .style("font-size", "12px")
      .text("Price Range");

    g.append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", -35)
      .attr("x", -height/2)
      .attr("text-anchor", "middle")
      .attr("fill", "#e2e8f0")
      .style("font-size", "12px")
      .text("Count");
  }

  // Create slopegraph - mobile optimized
  function createSlopegraph(hospitalData) {
    slopegraphSvg.selectAll("*").remove();
    
    if (!hospitalData || hospitalData.length === 0) {
      slopegraphSvg.append("text")
        .attr("x", "50%")
        .attr("y", "50%")
        .attr("text-anchor", "middle")
        .attr("fill", "#94a3b8")
        .style("font-size", "14px")
        .text("No data to display");
      return;
    }

    const margin = {top: 20, right: 60, bottom: 40, left: 60};
    const containerWidth = parseInt(slopegraphSvg.style("width")) || 300;
    const containerHeight = parseInt(slopegraphSvg.style("height")) || 250;
    const width = containerWidth - margin.left - margin.right;
    const height = containerHeight - margin.top - margin.bottom;

    const g = slopegraphSvg.append("g")
      .attr("transform", `translate(${margin.left},${margin.top})`);

    // Prepare data - get hospitals with both min and max prices
    const slopeData = hospitalData.filter(h => {
      const hits = h.hits || [];
      const minPrices = hits.filter(hit => hit.standard_charge_min != null);
      const maxPrices = hits.filter(hit => hit.standard_charge_max != null);
      return minPrices.length > 0 && maxPrices.length > 0;
    }).slice(0, 8); // Limit to 8 hospitals for mobile readability

    if (slopeData.length === 0) {
      g.append("text")
        .attr("x", width/2)
        .attr("y", height/2)
        .attr("text-anchor", "middle")
        .attr("fill", "#94a3b8")
        .style("font-size", "14px")
        .text("No min/max price data available");
      return;
    }

    // Calculate averages for each hospital
    const processedData = slopeData.map(h => {
      const hits = h.hits || [];
      const minPrices = hits.filter(hit => hit.standard_charge_min != null).map(hit => +hit.standard_charge_min);
      const maxPrices = hits.filter(hit => hit.standard_charge_max != null).map(hit => +hit.standard_charge_max);
      
      return {
        hospital: h.name,
        minAvg: d3.mean(minPrices),
        maxAvg: d3.mean(maxPrices)
      };
    }).filter(d => d.minAvg != null && d.maxAvg != null);

    if (processedData.length === 0) return;

    // Scales
    const allValues = processedData.flatMap(d => [d.minAvg, d.maxAvg]);
    const yScale = d3.scaleLinear()
      .domain(d3.extent(allValues))
      .range([height, 0]);

    // Color scale for different hospitals
    const colorScale = d3.scaleOrdinal()
      .domain(processedData.map(d => d.hospital))
      .range(d3.schemeCategory10);

    const xPositions = [0, width];

    // Draw lines with touch-friendly interaction
    const lines = g.selectAll(".slope-line")
      .data(processedData)
      .join("path")
      .attr("d", d => d3.line()([[xPositions[0], yScale(d.minAvg)], [xPositions[1], yScale(d.maxAvg)]]))
      .style("stroke", d => colorScale(d.hospital))
      .style("stroke-width", "4px")
      .style("fill", "none")
      .style("opacity", 0.8)
      .style("cursor", "pointer");

    // Add invisible hit areas for better touch interaction
    g.selectAll(".slope-hit-area")
      .data(processedData)
      .join("path")
      .attr("class", "slope-hit-area")
      .attr("d", d => d3.line()([[xPositions[0], yScale(d.minAvg)], [xPositions[1], yScale(d.maxAvg)]]))
      .style("stroke", "transparent")
      .style("stroke-width", "12px")
      .style("fill", "none")
      .style("cursor", "pointer")
      .on("touchstart", function(event, d) {
        event.preventDefault();
        // Highlight the corresponding line
        const lineIndex = processedData.indexOf(d);
        lines.style("opacity", (_, i) => i === lineIndex ? 1 : 0.3);
        
        alert(`${d.hospital}\nMin Avg: $${Math.round(d.minAvg).toLocaleString()}\nMax Avg: $${Math.round(d.maxAvg).toLocaleString()}`);
        
        // Reset highlighting after a delay
        setTimeout(() => {
          lines.style("opacity", 0.8);
        }, 2000);
      })
      .on("click", function(event, d) {
        event.preventDefault();
        // Highlight the corresponding line
        const lineIndex = processedData.indexOf(d);
        lines.style("opacity", (_, i) => i === lineIndex ? 1 : 0.3);
        
        alert(`${d.hospital}\nMin Avg: $${Math.round(d.minAvg).toLocaleString()}\nMax Avg: $${Math.round(d.maxAvg).toLocaleString()}`);
        
        // Reset highlighting after a delay
        setTimeout(() => {
          lines.style("opacity", 0.8);
        }, 2000);
      });

    // Draw dots
    g.selectAll(".slope-dot-min")
      .data(processedData)
      .join("circle")
      .attr("class", "slope-dot")
      .attr("cx", xPositions[0])
      .attr("cy", d => yScale(d.minAvg))
      .attr("r", 4)
      .attr("fill", d => colorScale(d.hospital))
      .attr("stroke", "#fff")
      .attr("stroke-width", 2);

    g.selectAll(".slope-dot-max")
      .data(processedData)
      .join("circle")
      .attr("class", "slope-dot")
      .attr("cx", xPositions[1])
      .attr("cy", d => yScale(d.maxAvg))
      .attr("r", 4)
      .attr("fill", d => colorScale(d.hospital))
      .attr("stroke", "#fff")
      .attr("stroke-width", 2);

    // Add labels
    g.append("text")
      .attr("x", xPositions[0])
      .attr("y", -5)
      .attr("text-anchor", "middle")
      .attr("fill", "#e2e8f0")
      .style("font-size", "12px")
      .text("Min");

    g.append("text")
      .attr("x", xPositions[1])
      .attr("y", -5)
      .attr("text-anchor", "middle")
      .attr("fill", "#e2e8f0")
      .style("font-size", "12px")
      .text("Max");

    // Add y-axis with better formatting
    const yAxisFormat = d => {
      if (d >= 1000000) return `$${(d/1000000).toFixed(1)}M`;
      if (d >= 1000) return `$${(d/1000).toFixed(0)}k`;
      return `$${d.toFixed(0)}`;
    };
    
    g.append("g")
      .attr("class", "axis")
      .call(d3.axisLeft(yScale).tickFormat(yAxisFormat).ticks(4));
  }

  // Update all visualizations
  function updateVisualizations(hospitalList, hitsById) {
    // Prepare data
    const allHits = [];
    const hospitalData = hospitalList.map(h => {
      const hits = hitsById.get(h.id) || [];
      allHits.push(...hits);
      return { ...h, hits };
    });

    // Update charts
    createDistributionChart(allHits);
    createSlopegraph(hospitalData);
  }

  // Service selector change handler
  $service.addEventListener('change', () => {
    const procedureSection = document.getElementById('procedure-section');
    if ($service.value === 'custom') {
      // Show search bar for custom pattern
      procedureSection.style.display = 'block';
      $q.placeholder = "e.g. (MRI|70551)|^70551$";
      $q.value = '';
    } else if ($service.value) {
      // Hide search bar for predefined services
      procedureSection.style.display = 'none';
      $q.value = ''; // Clear custom pattern when service is selected
    } else {
      // Hide search bar when no selection
      procedureSection.style.display = 'none';
      $q.value = '';
    }
  });

  setStatus("Ready to search hospital price data.");

  function renderHospitals(hlist, hitsById){
    $list.innerHTML = "";
    $listTitle.textContent = `Hospitals (${hlist.length})`;
    const pts = hospLayer.selectAll("circle.marker-hosp").data(hlist, d=>d.id);
    pts.join(
      en => en.append("circle").attr("class","marker-hosp").attr("r",3.5)
                .attr("cx", d => projection(d.ll)?.[0] ?? -9999)
                .attr("cy", d => projection(d.ll)?.[1] ?? -9999),
      up => up.attr("cx", d => projection(d.ll)?.[0] ?? -9999)
              .attr("cy", d => projection(d.ll)?.[1] ?? -9999),
      ex => ex.remove()
    );
    for(const h of hlist){
      const div = document.createElement("div"); div.className = "card";
      const hits = hitsById.get(h.id) || [];
      const hospitalId = `hospital-${h.id}`;
      
      div.innerHTML = `
        <div class="hospital-header" onclick="toggleHospitalPrices('${hospitalId}')">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <strong>${h.name}</strong> 
              <span class="badge">${h.state ?? ""}</span>
            </div>
            <div class="toggle-indicator clickable" id="toggle-${hospitalId}">‚ñ∂</div>
          </div>
          <div class="small">${h.zip ?? ""} ¬∑ ${h.lat?.toFixed?.(4) ?? ""}, ${h.lon?.toFixed?.(4) ?? ""}</div>
          ${hits.length ? `<div style="margin-top:.5rem"><strong>${hits.length}</strong> match${hits.length>1?"es":""} found - tap to view</div>` : `<div class="small" style="margin-top:.5rem">No matches in price data</div>`}
        </div>
        ${hits.length ? `
          <div class="hospital-prices" id="${hospitalId}">
            ${hits.slice(0,hits.length).map(r => `
              <div class="price-item">
                ${r.payer_name || r.plan_name ? `
                  <div class="payer-info">
                    ${r.payer_name ? r.payer_name : ""}${r.payer_name && r.plan_name ? " - " : ""}${r.plan_name ? r.plan_name : ""}
                  </div>
                ` : ""}
                <div style="margin-bottom:.5rem"><code>${r.code ?? ""}</code> ‚Äî ${r.description ?? ""}</div>
                ${generatePriceTable(r)}
              </div>
            `).join("")}
          </div>
        ` : ""}
      `;
      
      // Add click handler for map zoom (only on hospital name area, not the toggle)
      const hospitalNameArea = div.querySelector('.hospital-header > div:first-child > div:first-child strong');
      if (hospitalNameArea) {
        hospitalNameArea.style.cursor = 'pointer';
        hospitalNameArea.ontouchstart = (e) => {
          e.preventDefault();
          e.stopPropagation(); // Prevent triggering the toggle
          const p = projection(h.ll); if(!p) return;
          svg.transition().duration(600)
            .call(zoom.transform, d3.zoomIdentity.translate(WIDTH/2 - p[0]*6, HEIGHT/2 - p[1]*6).scale(6));
        };
      }
      
      $list.appendChild(div);
    }
    
    // Store current data and update visualizations
    currentHospitalList = hlist;
    currentHitsById = hitsById;
    updateVisualizations(hlist, hitsById);
    
    // Reset the expand all state when new results come in
    allExpanded = false;
    document.querySelector('.toggle-all-btn').textContent = 'Expand All';
  }

  async function loadHospitalJSON(jsonPath) {
    if (!jsonPath) return [];
    
    try {
      // Check cache first
      if (jsonCache.has(jsonPath)) {
        return jsonCache.get(jsonPath);
      }
      
      // Load JSON file
      const url = jsonUrl(jsonPath);
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const text = await response.text();
      // Parse JSON lines format (each line is a separate JSON object)
      const jsonData = text.trim().split('\n').map(line => {
        try {
          return JSON.parse(line);
        } catch (e) {
          console.warn("Failed to parse JSON line:", line.substring(0, 100));
          return null;
        }
      }).filter(obj => obj !== null);
      
      // Cache the parsed data
      jsonCache.set(jsonPath, jsonData);
      return jsonData;
      
    } catch(e) {
      console.warn("JSON loading failed:", jsonPath, e);
      return [];
    }
  }

  async function queryHospitalJSON(jsonPath, regexOrCode, selectedPayer = null){
    if (!jsonPath || !regexOrCode) return [];
    
    try {
      const jsonData = await loadHospitalJSON(jsonPath);
      
      // Create regex for searching
      const regex = new RegExp(regexOrCode, 'i');
      
      // Search through descriptions, codes, and code_2 fields
      let matches = jsonData.filter(record => {
        const description = record.description || '';
        const code = record.code || '';
        const code2 = record.code_2 || '';
        const matchesRegex = regex.test(description) || regex.test(code) || regex.test(code2);
        const matchesPayer = !selectedPayer || (record.payer_name && record.payer_name === selectedPayer);
        return matchesRegex && matchesPayer;
      }).slice(0, 30); // Limit to 30 results for mobile performance
      
      // Sort by estimated_amount if available
      matches.sort((a, b) => {
        const aAmount = parseFloat(a.estimated_amount) || 0;
        const bAmount = parseFloat(b.estimated_amount) || 0;
        return aAmount - bAmount;
      });
      
      return matches;
      
    } catch(e){
      console.warn("JSON query failed:", jsonPath, e);
      return [];
    }
  }

  async function getUniquePayers(hospitalList) {
    const payerSet = new Set();
    
    // Load all JSON files for hospitals in the list and extract unique payers
    const promises = hospitalList.slice(0, 20).map(async (hospital) => { // Limit for mobile performance
      if (!hospital.json_path) return;
      
      try {
        const jsonData = await loadHospitalJSON(hospital.json_path);
        jsonData.forEach(record => {
          if (record.payer_name && record.payer_name.trim()) {
            payerSet.add(record.payer_name.trim());
          }
        });
      } catch (e) {
        console.warn("Failed to load payers from:", hospital.json_path);
      }
    });
    
    await Promise.all(promises);
    
    // Convert set to sorted array
    return Array.from(payerSet).sort();
  }

  function populatePayerDropdown(payers) {
    // Save the currently selected payer
    const currentSelection = $payer.value;
    
    // Clear existing options except "All Payers"
    $payer.innerHTML = '<option value="">All Payers</option>';
    
    // Add unique payers
    payers.forEach(payer => {
      const option = document.createElement('option');
      option.value = payer;
      option.textContent = payer;
      $payer.appendChild(option);
    });
    
    // Restore the previous selection if it still exists in the new list
    if (currentSelection && payers.includes(currentSelection)) {
      $payer.value = currentSelection;
    }
  }

  async function go(){
    const rawZip = ($zip.value||"").trim();
    const zip = rawZip.padStart(5,'0').slice(-5);
    const miles = +$radius.value;
    const svcName = $service.value;
    const q = ($q.value||"").trim();
    const selectedPayer = $payer.value || null;
    
    // Get the search pattern - either from service or custom query
    let searchPattern = '';
    if (svcName && svcName !== 'custom' && services.has(svcName)) {
      const svcRegex = services.get(svcName);
      searchPattern = svcRegex.source; // Get the regex pattern string
    } else if (svcName === 'custom' && q) {
      searchPattern = q;
    }

    if(!ZIP.has(zip)){ setStatus(`ZIP ${zip} not found.`); return; }
    if(!hospitals.length){ setStatus("No hospitals index loaded."); return; }

    const [lat,lon] = ZIP.get(zip); const center = [lon, lat];
    
    let nearby;
    if (miles >= 500) {
      // 500+ mode: show all hospitals, no circle, no zoom
      circlePath.style("display", "none");
      nearby = hospitals.filter(h => isFinite(h.lon) && isFinite(h.lat));
      const p = projection(center); if(p) zipMarker.attr("cx", p[0]).attr("cy", p[1]).style("display", null);
      setStatus(`Showing all ${nearby.length} hospitals. Loading payers...`);
    } else {
      // Normal radius mode
      const circle = d3.geoCircle().center(center).radius(miles2deg(miles))();
      circlePath.datum(circle).attr("d", path).style("display", null);
      const p = projection(center); if(p) zipMarker.attr("cx", p[0]).attr("cy", p[1]).style("display", null);
      zoomTo(circle);
      nearby = hospitals.filter(h => isFinite(h.lon) && isFinite(h.lat) && gcMiles(center, h.ll) <= miles);
      setStatus(`Found ${nearby.length} hospitals within ${miles} mi. Loading payers...`);
    }

    // Load unique payers from hospitals in radius
    try {
      const uniquePayers = await getUniquePayers(nearby);
      populatePayerDropdown(uniquePayers);
      const searchDesc = svcName || q;
      const statusMsg = miles >= 500 
        ? `Showing all ${nearby.length} hospitals. ${searchDesc ? "Searching prices..." : "(select a service or enter a procedure to search prices)"}`
        : `Found ${nearby.length} hospitals within ${miles} mi. ${searchDesc ? "Searching prices..." : "(select a service or enter a procedure to search prices)"}`;
      setStatus(statusMsg);
    } catch (e) {
      console.warn("Failed to load payers:", e);
      const searchDesc = svcName || q;
      const statusMsg = miles >= 500 
        ? `Showing all ${nearby.length} hospitals. ${searchDesc ? "Searching prices..." : "(select a service or enter a procedure to search prices)"}`
        : `Found ${nearby.length} hospitals within ${miles} mi. ${searchDesc ? "Searching prices..." : "(select a service or enter a procedure to search prices)"}`;
      setStatus(statusMsg);
    }

    const hitsById = new Map();
    const pool = 2; // Reduced for mobile performance
    let i = 0;
    async function worker(){
      while(i < nearby.length){
        const h = nearby[i++];
        const hits = (ENABLE_PRICES && searchPattern && h.json_path) ? await queryHospitalJSON(h.json_path, searchPattern, selectedPayer) : [];
        hitsById.set(h.id, hits);
      }
    }
    await Promise.all(Array.from({length: pool}, worker));
    renderHospitals(nearby, hitsById);
    const searchDesc = svcName || q;
    const doneMsg = miles >= 500 
      ? `Done. All ${nearby.length} hospitals searched${searchDesc ? ` for "${searchDesc}"` : ""}.`
      : `Done. ${nearby.length} hospitals searched${searchDesc ? ` for "${searchDesc}"` : ""}.`;
    setStatus(doneMsg);
  }

  // Toggle function for hospital price display
  window.toggleHospitalPrices = (hospitalId) => {
    const pricesDiv = document.getElementById(hospitalId);
    const toggleIndicator = document.getElementById(`toggle-${hospitalId}`);
    
    if (pricesDiv && toggleIndicator) {
      const isExpanded = pricesDiv.classList.contains('expanded');
      
      if (isExpanded) {
        pricesDiv.classList.remove('expanded');
        toggleIndicator.classList.remove('expanded');
        toggleIndicator.textContent = '‚ñ∂';
      } else {
        pricesDiv.classList.add('expanded');
        toggleIndicator.classList.add('expanded');
        toggleIndicator.textContent = '‚ñº';
      }
    }
  };

  // Store current data for visualization updates
  let currentHospitalList = [];
  let currentHitsById = new Map();

  // Event listeners with mobile optimizations
  $go.addEventListener("click", go);
  $zip.addEventListener("keydown", e => { if(e.key==="Enter") go(); });
  $radius.addEventListener("change", go);
  $payer.addEventListener("change", go);
  $service.addEventListener("change", go);
  $unit.addEventListener("change", () => {
    go(); // This will refresh both tables and visualizations
  });

  // Prevent zoom on double-tap
  document.addEventListener('touchstart', function(e) {
    if (e.touches.length > 1) {
      e.preventDefault();
    }
  }, { passive: false });

  let lastTouchEnd = 0;
  document.addEventListener('touchend', function(e) {
    const now = (new Date()).getTime();
    if (now - lastTouchEnd <= 300) {
      e.preventDefault();
    }
    lastTouchEnd = now;
  }, false);
  </script>
</body>
</html>