<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Hospital Price Finder (ZIP Radius + Procedure)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- d3 as global (ok inside module) -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
  :root{--bg:#0f172a;--ink:#e2e8f0;--muted:#9aa6b2;}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px system-ui,Segoe UI,Roboto,Helvetica,Arial}
  header{position:sticky;top:0;z-index:10;display:flex;gap:.5rem;align-items:center;padding:.6rem .8rem;background:rgba(15,23,42,.95);backdrop-filter:blur(8px);flex-wrap:wrap}
  input,select,button{background:#111827;color:var(--ink);border:1px solid #1f2937;border-radius:.5rem;padding:.45rem .55rem}
  label{display:flex;align-items:center;gap:.35rem}
  button{cursor:pointer}
  #status{color:var(--muted);font-size:12px}
  main{display:grid;grid-template-columns:1fr 360px}
  svg{display:block;width:100%;height:calc(100vh - 56px)}
  aside{border-left:1px solid #1f2937;height:calc(100vh - 56px);overflow:auto;padding:.6rem}
  aside h3{margin:.25rem 0 .5rem}
  .card{border:1px solid #1f2937;background:#0b1325;border-radius:.6rem;padding:.55rem;margin-bottom:.55rem}
  .card code{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
  .state{fill:#1e293b;stroke:#94a3b8;stroke-width:.6px}
  .graticule{fill:none;stroke:#334155;stroke-opacity:.35}
  .circle{fill:rgba(99,102,241,.12);stroke:#8b5cf6;stroke-width:1.5px}
  .marker-zip{fill:#f43f5e;stroke:#fff;stroke-width:1.2px}
  .marker-hosp{fill:#22c55e;stroke:#0b1325;stroke-width:1px}
  .small{font-size:12px;color:#93a4b3}
  .badge{display:inline-block;padding:.1rem .35rem;border:1px solid #334155;border-radius:.4rem;margin-left:.3rem;color:#cbd5e1}
  </style>
</head>
<body>
  <header>
    <label>Procedure (regex or code):
      <input id="q" placeholder="e.g. (MRI|70551)|^70551$" size="28"/>
    </label>
    <label>ZIP: <input id="zip" placeholder="e.g. 94105" size="8"/></label>
    <label>Radius:
      <select id="radius">
        <option value="10">10 mi</option>
        <option value="25" selected>25 mi</option>
        <option value="50">50 mi</option>
        <option value="100">100 mi</option>
        <option value="250">250 mi</option>
      </select>
    </label>
    <label>Payer:
      <select id="payer">
        <option value="">All Payers</option>
      </select>
    </label>
    <button id="go">Search</button>
    <span id="status"></span>
  </header>

  <main>
    <svg id="map" viewBox="0 0 960 600" aria-label="US map"></svg>
    <aside>
      <h3 id="list-title">Hospitals (0)</h3>
      <div class="small">Shows hospitals within the radius; price hits appear under each.</div>
      <div id="list"></div>
    </aside>
  </main>

  <script type="module">
  import * as topojson from "https://cdn.jsdelivr.net/npm/topojson-client@3/+esm";

  // --------- CONFIG / URL HELPERS ----------
  const WIDTH = 960, HEIGHT = 600, EARTH_MI = 3958.7613;
  const ENABLE_PRICES = true;  // set false to debug map/CSV only

  // robust path resolution relative to this HTML file
  const urlFrom = (p) => p;  // Simple relative path resolution
  const DATA_ZIPS = "data/zip_centroids.csv";
  const DATA_HOSPS = "data/hospitals.csv";
  const jsonUrl = (relPath) => relPath.startsWith('docs/') ? relPath.substring(5) : relPath;

  // --------- ELEMENTS ----------
  const svg = d3.select("#map");
  const $q = document.getElementById("q");
  const $zip = document.getElementById("zip");
  const $radius = document.getElementById("radius");
  const $payer = document.getElementById("payer");
  const $go = document.getElementById("go");
  const $status = document.getElementById("status");
  const $list = document.getElementById("list");
  const $listTitle = document.getElementById("list-title");
  const setStatus = (t)=> $status.textContent = t;

  // --------- MAP ----------
  const projection = d3.geoAlbersUsa().translate([WIDTH/2, HEIGHT/2]).scale(1200);
  const path = d3.geoPath(projection);
  const gBase = svg.append("g");
  const gOverlay = svg.append("g");
  const zoom = d3.zoom().scaleExtent([1, 20]).on("zoom", (ev) => {
    gBase.attr("transform", ev.transform);
    gOverlay.attr("transform", ev.transform);
    gOverlay.selectAll(".marker-zip").attr("r", 4/ev.transform.k);
    gOverlay.selectAll(".marker-hosp").attr("r", 3.5/ev.transform.k);
  });
  svg.call(zoom);

  const circlePath = gOverlay.append("path").attr("class","circle").style("display","none");
  const zipMarker  = gOverlay.append("circle").attr("class","marker-zip").attr("r",4).style("display","none");
  const hospLayer  = gOverlay.append("g").attr("class","hospitals");

  const miles2deg = (mi)=> mi/69;
  const gcMiles = (aLonLat, bLonLat)=> d3.geoDistance(aLonLat, bLonLat) * EARTH_MI;
  function zoomTo(feature, pad=20){
    const [[x0,y0],[x1,y1]] = path.bounds(feature);
    const dx=x1-x0, dy=y1-y0, cx=(x0+x1)/2, cy=(y0+y1)/2;
    const scale = Math.max(1, Math.min(20, 0.9/Math.max(dx/(WIDTH-2*pad), dy/(HEIGHT-2*pad))));
    const translate = [WIDTH/2 - scale*cx, HEIGHT/2 - scale*cy];
    svg.transition().duration(800)
       .call(zoom.transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale));
  }

  // 1) BASEMAP FIRST (isolated)
  try {
    const graticule = d3.geoGraticule10();
    gBase.append("path").attr("class","graticule").attr("d", path(graticule));
    const res = await fetch("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json");
    if (!res.ok) throw new Error(`us-atlas fetch failed: ${res.status}`);
    const us = await res.json();
    const states = topojson.feature(us, us.objects.states).features;
    gBase.selectAll("path.state").data(states).join("path").attr("class","state").attr("d", path);
  } catch (err) {
    console.error("Basemap error:", err);
    setStatus("Basemap failed to load. See console.");
  }

  // 2) SMALL CSVs
  let ZIP = new Map(), hospitals = [];
  try {
    const zipRows = await d3.csv(DATA_ZIPS, d3.autoType);
    ZIP = new Map(zipRows.map(d=>[String(d.zip).padStart(5,'0'), [d.lat, d.lon]]));
  } catch (e) {
    console.warn("zip_centroids.csv failed:", e);
    setStatus("ZIP data missing.");
  }
  try {
    hospitals = await d3.csv(DATA_HOSPS, d3.autoType);
    hospitals.forEach(d => { 
      d.ll = [d.lon, d.lat]; 
      // Use json_path from CSV
      d.json_path = d.json_path || '';
    });

  } catch (e) {
    console.warn("hospitals.csv failed:", e);
    setStatus("Hospitals index missing.");
  }

  // 3) JSON Loading Cache
  const jsonCache = new Map(); // Cache loaded JSON files
  

  
  setStatus("Ready to search JSON price files.");

  function renderHospitals(hlist, hitsById){
    $list.innerHTML = "";
    $listTitle.textContent = `Hospitals (${hlist.length})`;
    const pts = hospLayer.selectAll("circle.marker-hosp").data(hlist, d=>d.id);
    pts.join(
      en => en.append("circle").attr("class","marker-hosp").attr("r",3.5)
                .attr("cx", d => projection(d.ll)?.[0] ?? -9999)
                .attr("cy", d => projection(d.ll)?.[1] ?? -9999),
      up => up.attr("cx", d => projection(d.ll)?.[0] ?? -9999)
              .attr("cy", d => projection(d.ll)?.[1] ?? -9999),
      ex => ex.remove()
    );
    for(const h of hlist){
      const div = document.createElement("div"); div.className = "card";
      const hits = hitsById.get(h.id) || [];
      div.innerHTML = `
        <div><strong>${h.name}</strong> <span class="badge">${h.state ?? ""}</span></div>
        <div class="small">${h.zip ?? ""} · ${h.lat?.toFixed?.(4) ?? ""}, ${h.lon?.toFixed?.(4) ?? ""}</div>
        ${hits.length ? `<div style="margin-top:.4rem"><strong>${hits.length}</strong> match${hits.length>1?"es":""}</div>` : `<div class="small" style="margin-top:.4rem">No matches in file</div>`}
        ${hits.slice(0,hits.length).map(r => `
          <div style="margin-top:.35rem">
            <div><code>${r.code_2 ?? ""}</code> — ${r.description ?? ""}</div>
            <div class="small">
              ${r.estimated_amount!=null ? "Est: $"+Number(r.estimated_amount).toLocaleString() : ""}
              ${r.standard_charge_min!=null ? " | Min: $"+Number(r.standard_charge_min).toLocaleString() : ""}
              ${r.standard_charge_max!=null ? " | Max: $"+Number(r.standard_charge_max).toLocaleString() : ""}
            </div>
            <div class="small" style="color:#93a4b3; margin-top:.2rem">
              ${r.payer_name ? "Payer: " + r.payer_name : ""}
              ${r.plan_name ? " | Plan: " + r.plan_name : ""}
            </div>
          </div>
        `).join("")}
      `;
      div.onclick = () => {
        const p = projection(h.ll); if(!p) return;
        svg.transition().duration(600)
          .call(zoom.transform, d3.zoomIdentity.translate(WIDTH/2 - p[0]*6, HEIGHT/2 - p[1]*6).scale(6));
      };
      $list.appendChild(div);
    }
  }

  async function loadHospitalJSON(jsonPath) {
    if (!jsonPath) return [];
    
    try {
      // Check cache first
      if (jsonCache.has(jsonPath)) {
        return jsonCache.get(jsonPath);
      }
      
      // Load JSON file
      const url = jsonUrl(jsonPath);
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const text = await response.text();
      // Parse JSON lines format (each line is a separate JSON object)
      const jsonData = text.trim().split('\n').map(line => {
        try {
          return JSON.parse(line);
        } catch (e) {
          console.warn("Failed to parse JSON line:", line.substring(0, 100));
          return null;
        }
      }).filter(obj => obj !== null);
      
      // Cache the parsed data
      jsonCache.set(jsonPath, jsonData);
      return jsonData;
      
    } catch(e) {
      console.warn("JSON loading failed:", jsonPath, e);
      return [];
    }
  }

  async function queryHospitalJSON(jsonPath, regexOrCode, selectedPayer = null){
    if (!jsonPath || !regexOrCode) return [];
    
    try {
      const jsonData = await loadHospitalJSON(jsonPath);
      
      // Create regex for searching
      const regex = new RegExp(regexOrCode, 'i');
      
      // Search through descriptions and return matching records
      let matches = jsonData.filter(record => {
        const description = record.description || '';
        const matchesRegex = regex.test(description);
        const matchesPayer = !selectedPayer || (record.payer_name && record.payer_name === selectedPayer);
        return matchesRegex && matchesPayer;
      }).slice(0, 50); // Limit to 50 results
      
      // Sort by estimated_amount if available
      matches.sort((a, b) => {
        const aAmount = parseFloat(a.estimated_amount) || 0;
        const bAmount = parseFloat(b.estimated_amount) || 0;
        return aAmount - bAmount;
      });
      
      return matches;
      
    } catch(e){
      console.warn("JSON query failed:", jsonPath, e);
      return [];
    }
  }

  async function getUniquePayers(hospitalList) {
    const payerSet = new Set();
    
    // Load all JSON files for hospitals in the list and extract unique payers
    const promises = hospitalList.map(async (hospital) => {
      if (!hospital.json_path) return;
      
      try {
        const jsonData = await loadHospitalJSON(hospital.json_path);
        jsonData.forEach(record => {
          if (record.payer_name && record.payer_name.trim()) {
            payerSet.add(record.payer_name.trim());
          }
        });
      } catch (e) {
        console.warn("Failed to load payers from:", hospital.json_path);
      }
    });
    
    await Promise.all(promises);
    
    // Convert set to sorted array
    return Array.from(payerSet).sort();
  }

  function populatePayerDropdown(payers) {
    // Save the currently selected payer
    const currentSelection = $payer.value;
    
    // Clear existing options except "All Payers"
    $payer.innerHTML = '<option value="">All Payers</option>';
    
    // Add unique payers
    payers.forEach(payer => {
      const option = document.createElement('option');
      option.value = payer;
      option.textContent = payer;
      $payer.appendChild(option);
    });
    
    // Restore the previous selection if it still exists in the new list
    if (currentSelection && payers.includes(currentSelection)) {
      $payer.value = currentSelection;
    }
  }

  async function go(){
    const rawZip = ($zip.value||"").trim();
    const zip = rawZip.padStart(5,'0').slice(-5);
    const miles = +$radius.value;
    const q = ($q.value||"").trim();
    const selectedPayer = $payer.value || null;

    if(!ZIP.has(zip)){ setStatus(`ZIP ${zip} not found.`); return; }
    if(!hospitals.length){ setStatus("No hospitals index loaded."); return; }

    const [lat,lon] = ZIP.get(zip); const center = [lon, lat];
    const circle = d3.geoCircle().center(center).radius(miles2deg(miles))();
    circlePath.datum(circle).attr("d", path).style("display", null);
    const p = projection(center); if(p) zipMarker.attr("cx", p[0]).attr("cy", p[1]).style("display", null);
    zoomTo(circle);

    const nearby = hospitals.filter(h => isFinite(h.lon) && isFinite(h.lat) && gcMiles(center, h.ll) <= miles);
    setStatus(`Found ${nearby.length} hospitals within ${miles} mi. Loading payers...`);

    // Load unique payers from hospitals in radius
    try {
      const uniquePayers = await getUniquePayers(nearby);
      populatePayerDropdown(uniquePayers);
      setStatus(`Found ${nearby.length} hospitals within ${miles} mi. ${q ? "Querying prices..." : "(enter a procedure to search prices)"}`);
    } catch (e) {
      console.warn("Failed to load payers:", e);
      setStatus(`Found ${nearby.length} hospitals within ${miles} mi. ${q ? "Querying prices..." : "(enter a procedure to search prices)"}`);
    }

    const hitsById = new Map();
    const pool = 4; let i = 0;
    async function worker(){
      while(i < nearby.length){
        const h = nearby[i++];
        const hits = (ENABLE_PRICES && q && h.json_path) ? await queryHospitalJSON(h.json_path, q, selectedPayer) : [];
        hitsById.set(h.id, hits);
      }
    }
    await Promise.all(Array.from({length: pool}, worker));
    renderHospitals(nearby, hitsById);
    setStatus(`Done. ${nearby.length} hospitals searched${q ? ` for “${q}”` : ""}.`);
  }

  $go.addEventListener("click", go);
  $zip.addEventListener("keydown", e => { if(e.key==="Enter") go(); });
  $radius.addEventListener("change", go);
  $payer.addEventListener("change", go);
  </script>
</body>
</html>
